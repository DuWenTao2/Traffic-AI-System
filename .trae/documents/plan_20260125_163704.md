# 双向速度违规检测功能优化计划

## 1. 需求分析与实现目标

### 1.1 核心需求
- 将现有的单一speed_limit参数替换为最高速度和最低速度两个独立参数
- 实现超速检测（超过最高速度）
- 实现低速检测（低于最低速度）
- 保持与现有违规记录机制的一致性
- 确保文件管理规范与项目现有结构一致
- 与现有架构无缝集成

### 1.2 实现目标
- 修改main_np.py中的速度限制配置
- 更新VideoProcessorMP以支持双向速度限制
- 增强SpeedDetector实现双向违规检测
- 保持与现有违规记录机制的兼容性

## 2. 实现步骤

### 2.1 修改Main_mp.py配置

**文件**: `Main_mp.py`

**修改内容**:
- 将现有的`speed_limit`参数替换为`max_speed`和`min_speed`
- 更新video_sources配置示例
- 确保向后兼容（如果只提供speed_limit则使用默认值）

**示例配置**:
```python
video_sources = [
    {
        "id": "video2", 
        "source": r"TestingVideos\test02.mp4",
        "use_stream": False,
        "location": "Test Road Intersection",
        "coordinates": {"lat": 0.0, "lng": 0.0},
        "max_speed": 50,      # 最高速度限制
        "min_speed": 10       # 最低速度限制
    }
]
```

### 2.2 更新VideoProcessorMP

**文件**: `Processing Models/VideoProcessorMP.py`

**修改内容**:
- 在`__init__`方法中添加`min_speed`参数
- 存储最高和最低速度参数
- 在初始化SpeedDetector时传递这两个参数

**关键代码**:
```python
def __init__(self, video_id, source, use_stream=False, camera_location="Unknown", coordinates=None, max_speed=60, min_speed=5):
    # ... 现有代码 ...
    self.max_speed = max_speed
    self.min_speed = min_speed
    # ... 现有代码 ...
    
    # 在初始化SpeedDetector时传递参数
    self.speed_detector = SpeedDetector(
        stream_id=self.video_id,
        violation_manager=self.violation_manager
    )
    # 设置最高和最低速度
    self.speed_detector.set_speed_limits(self.max_speed, self.min_speed)
```

### 2.3 增强SpeedDetector

**文件**: `Models/Speed Model/speed_detector.py`

**修改内容**:
- 添加`min_speed`属性
- 修改`__init__`方法以接受`min_speed`参数
- 添加`set_speed_limits`方法来设置最高和最低速度
- 修改`_calculate_vehicle_speed`方法，同时检测超速和低速违规
- 更新违规记录逻辑，支持记录两种类型的违规

**关键代码**:
```python
def __init__(self, stream_id="default", pixels_per_meter=30, smoothing_window=10, font_style="plain", violation_manager=None):
    # ... 现有代码 ...
    self.speed_limit = 1.0  # 保留用于兼容，将作为最高速度
    self.min_speed = 5.0    # 新增：最低速度限制
    # ... 现有代码 ...

def set_speed_limits(self, max_speed, min_speed=None):
    """Set both maximum and minimum speed limits"""
    self.speed_limit = max_speed  # 最高速度
    if min_speed is not None:
        self.min_speed = min_speed
    print(f"[{self.stream_id}] Speed limits updated: max={self.speed_limit} km/h, min={self.min_speed} km/h")

# 在_calculate_vehicle_speed方法中添加低速检测
def _calculate_vehicle_speed(self, vehicle_id, speed_line_id=None):
    # ... 现有代码 ...
    
    # 检测超速违规
    if avg_speed > self.speed_limit and violation_key not in self.speed_violations:
        # 记录超速违规（现有代码）
        # ...
    
    # 新增：检测低速违规
    elif avg_speed > 0 and avg_speed < self.min_speed and violation_key not in self.speed_violations:
        try:
            self.speed_violations.add(violation_key)
            bbox = self._get_vehicle_bbox(vehicle_id)
            
            if bbox is not None and hasattr(self, 'current_frame'):
                if self.violation_manager:
                    violation_id, snapshot_paths = self.violation_manager.record_speed_violation(
                        self.current_frame, 
                        vehicle_id, 
                        bbox,
                        speed=avg_speed
                    )
                    print(f"[{self.stream_id}] Recorded SPEED VIOLATION for vehicle {vehicle_id}: " +
                         f"{avg_speed:.1f} km/h (below min limit: {self.min_speed} km/h) at line {speed_line_id}")
        except Exception as e:
            print(f"[{self.stream_id}] Error recording speed violation: {str(e)}")
```

### 2.4 更新违规记录机制

**文件**: `Violation_Proc/violation_manager.py`

**修改内容**:
- 增强`record_speed_violation`方法，添加违规类型参数
- 确保违规记录中包含速度限制信息

**关键代码**:
```python
def record_speed_violation(self, frame, vehicle_id, bbox, speed=None, violation_type="over_speed"):
    """Record a speed violation (over-speed or under-speed)"""
    extra_info = {
        "speed": speed,
        "violation_type": violation_type
    }
    return self._record_violation(frame, vehicle_id, bbox, "speed", extra_info=extra_info)
```

### 2.5 配置文件更新

**文件**: `config.conf`

**修改内容**:
- 在`[SPEED_DETECTION]`部分添加`min_speed_limit_kph`参数
- 更新配置说明

**配置示例**:
```ini
[SPEED_DETECTION]
enabled = true
distance_calibration_factor = 0.1  # meters per pixel
speed_limit_kph = 50  # 最高速度限制
min_speed_limit_kph = 10  # 最低速度限制
violation_threshold_kph = 55  # 兼容现有配置
```

## 3. 实现细节与技术要点

### 3.1 向后兼容性处理
- 保留现有`speed_limit`参数的处理逻辑
- 如果只提供`speed_limit`，则使用默认最低速度（如5 km/h）
- 确保现有代码不需要修改即可正常运行

### 3.2 违规记录一致性
- 使用与现有违规记录相同的格式
- 确保违规类型在记录中明确标识
- 保持截图命名和存储位置与现有结构一致

### 3.3 性能优化
- 避免重复计算
- 优化违规检测逻辑，减少不必要的计算
- 保持与现有性能水平一致

### 3.4 错误处理
- 添加适当的参数验证
- 处理配置缺失的情况
- 确保异常不会影响系统稳定性

## 4. 测试与验证

### 4.1 测试场景
- 配置不同的最高和最低速度组合
- 测试超速检测功能
- 测试低速检测功能
- 验证违规记录是否正确生成
- 检查文件存储位置和命名是否符合规范

### 4.2 验证要点
- 系统启动是否正常
- 双向速度检测是否正常工作
- 违规记录是否完整准确
- 文件管理是否符合规范
- 与其他功能模块是否冲突

## 5. 实施计划

### 5.1 实施顺序
1. 修改Main_mp.py配置
2. 更新VideoProcessorMP
3. 增强SpeedDetector
4. 更新违规记录机制
5. 修改配置文件
6. 测试与验证

### 5.2 预期完成时间
- 代码修改：1-2小时
- 测试与验证：1小时
- 文档更新：30分钟

## 6. 预期效果

### 6.1 功能效果
- 成功实现双向速度违规检测
- 配置灵活，支持不同场景需求
- 与现有系统无缝集成

### 6.2 技术效果
- 代码结构清晰，易于维护
- 保持向后兼容性
- 符合项目文件管理规范
- 性能稳定可靠

## 7. 风险与应对

### 7.1 风险
- 配置不一致导致系统异常
- 与现有违规记录机制冲突
- 性能下降

### 7.2 应对措施
- 完善配置验证和错误处理
- 严格遵循现有违规记录格式
- 优化算法，确保性能稳定

## 8. 结论

通过以上计划的实施，我们将成功实现双向速度违规检测功能，满足项目需求的同时保持与现有系统的一致性和稳定性。该优化将增强系统的功能完整性，提高交通监控的准确性和全面性。