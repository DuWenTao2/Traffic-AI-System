# 应急车道违规检测功能设计与实现

## 1. 项目架构与技术栈分析

### 1.1 项目架构
- **主入口**：Main_mp.py
- **视频处理**：Processing Models/VideoProcessorMP.py（多线程视频处理）
- **区域管理**：Processing Models/areas.py（区域创建、保存、加载和检测）
- **检测模型**：Models/目录下的各种检测模块
- **违规处理**：Violation_Proc/violation_manager.py（统一管理违规记录）

### 1.2 现有违规检测模式
以IllegalCrossingDetector为例，现有违规检测模块的实现模式：
- 定义特定的AreaType枚举值
- 创建检测器类，初始化时接收stream_id和violation_manager
- 实现process_objects方法，处理跟踪到的物体
- 检测物体是否进入指定区域，超过时间阈值判定为违规
- 使用violation_manager记录违规并保存截图
- 在视频帧上绘制违规信息

## 2. 应急车道违规检测功能设计

### 2.1 技术方案
采用"区域检测+轨迹分析"的技术方案：
- **区域检测**：用户绘制应急车道区域，检测车辆是否进入
- **轨迹分析**：跟踪车辆在应急车道内的停留时间，超过阈值判定为违规

### 2.2 实现步骤

#### 步骤1：添加应急车道区域类型
- 修改`Processing Models/areas.py`，在AreaType枚举中添加`EMERGENCY_LANE`
- 为应急车道区域添加颜色标识
- 添加键盘快捷键支持（数字键9）

#### 步骤2：创建应急车道检测器
- 创建`Models/EmergencyLane/emergency_lane_detector.py`文件
- 实现`EmergencyLaneDetector`类，参考`IllegalCrossingDetector`的实现模式
- 核心功能：
  - 跟踪进入应急车道的车辆
  - 记录车辆停留时间
  - 超过阈值判定为违规
  - 调用violation_manager记录违规

#### 步骤3：集成到视频处理器
- 修改`Processing Models/VideoProcessorMP.py`
- 在初始化方法中创建EmergencyLaneDetector实例
- 在process_frame方法中调用检测器的process_objects方法

#### 步骤4：更新违规管理器
- 修改`Violation_Proc/violation_manager.py`
- 添加`record_emergency_lane_violation`方法
- 支持应急车道违规记录

#### 步骤5：更新区域管理
- 在AreaManager的handle_key_events方法中添加应急车道区域类型的快捷键支持
- 更新区域绘制和显示逻辑

## 3. 代码实现细节

### 3.1 AreaType枚举扩展
```python
class AreaType(Enum):
    # ... 现有类型 ...
    EMERGENCY_LANE = auto()  # 应急车道区域
```

### 3.2 EmergencyLaneDetector核心实现
```python
class EmergencyLaneDetector:
    def __init__(self, stream_id="default", violation_time_limit=2, violation_manager=None):
        # 初始化代码
        self.emergency_lane_vehicles = {}  # 跟踪进入应急车道的车辆
        # ...
    
    def process_objects(self, frame, tracked_objects, area_manager):
        # 处理跟踪到的车辆
        # 检测是否进入应急车道
        # 超过时间阈值判定为违规
        # 记录违规信息
        # ...
```

### 3.3 集成到VideoProcessorMP
```python
# 在__init__方法中
self.emergency_lane_detector = EmergencyLaneDetector(
    stream_id=self.video_id,
    violation_manager=self.violation_manager
)

# 在process_frame方法中
self.emergency_lane_detector.process_objects(
    frame, tracked_vehicles, self.area_manager
)
```

## 4. 预期效果

- 用户可以使用键盘快捷键9切换到应急车道区域绘制模式
- 支持绘制多边形应急车道区域
- 自动检测进入应急车道的车辆
- 记录车辆在应急车道内的停留时间
- 超过阈值（默认2秒）判定为违规
- 违规车辆被标记，截图保存
- 与现有违规检测模块保持一致的操作体验和界面风格

## 5. 遵循的设计原则

- 遵循项目现有的代码风格和架构
- 保持与现有违规检测模块的一致性
- 模块化设计，便于维护和扩展
- 统一使用violation_manager处理违规记录
- 支持多线程视频处理